name: Unearth Credentials
on:
  workflow_call:
    inputs:
      exclude_git:
        description: "Exclude git directory"
        required: false
        type: boolean
        default: false
jobs:
  unearth-credentials:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: install trufflehog and jq
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq
          python -m pip install --upgrade pip
          python -m pip install 'trufflehog>=3.63,<3.65'
      - name: Run trufflehog
        id: trufflehog_scan
        run: |
          set -euo pipefail
          if [ "${{ inputs.exclude_git }}" = "true" ]; then
            trufflehog filesystem --json --exclude-dir .git ./ > trufflehog_raw_output.json
          else
            trufflehog filesystem --json ./ > trufflehog_raw_output.json
          fi
          jq -s '.' trufflehog_raw_output.json > trufflehog_output.json
      - name: Set Trufflehog Findings
        id: is_hardcoded_credentials_found
        run: |
          set -euo pipefail
          if [ -s trufflehog_raw_output.json ]; then
              echo "trufflehog_findings=true" >> "$GITHUB_OUTPUT"
          else
              echo "trufflehog_findings=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Parse Trufflehog Outputs
        if: ${{ steps.is_hardcoded_credentials_found.outputs.trufflehog_findings == 'true' }}
        shell: python
        id: trufflehog_findings
        run: |
            import json
            import os
            from pathlib import Path
            from typing import Any, Dict, List


            def parse_json(json_path: Path) -> List[Dict[str, Any]]:
                if not json_path.exists():
                    return []

                raw_content = json_path.read_text(encoding="utf-8").strip()
                if not raw_content:
                    return []

                data = json.loads(raw_content)
                parsed: List[Dict[str, Any]] = []
                for item in data:
                    metadata = item.get("SourceMetadata", {}).get("Data", {}).get("Filesystem", {})
                    parsed.append(
                        {
                            "file": metadata.get("file"),
                            "line": metadata.get("line"),
                            "verified": item.get("Verified"),
                        }
                    )
                return parsed


            def log_findings(findings: List[Dict[str, Any]]) -> None:
                if not findings:
                    print("No credential found. Happy Coding!")
                    return

                for finding in findings:
                    print("----------------------------------")
                    print("Potential credential found at")
                    print(f"  file: {finding.get('file')}")
                    print(f"  line: {finding.get('line')}")
                    print(f"  verified: {finding.get('verified')}")
                    print("----------------------------------")
                    print("")


            if __name__ == "__main__":
                findings = parse_json(Path("trufflehog_output.json"))
                log_findings(findings)
                with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as output_file:
                    output_file.write(f"trufflehog_findings_data={json.dumps(findings)}\n")
      - id: repo_info
        run: |
          REPO_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          WORKFLOW_URL="${REPO_URL}/actions/runs/${GITHUB_RUN_ID}"
          echo "WORKFLOW_URL=$WORKFLOW_URL" >> $GITHUB_OUTPUT
      - name: slack-send
        if: ${{ steps.is_hardcoded_credentials_found.outputs.trufflehog_findings == 'true' && secrets.SECURITY_WEBHOOK_URL != '' }}
        run: |
          payload=$(cat <<EOF
          {
            "text": "ðŸš¨ !!! Hard-coded Credentials found in ${{ github.repository }}. !!! Please review the findings by clicking the button below.",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":alert: *!!! Hard-coded Credentials found in ${{ github.repository }}, branch ${GITHUB_REF#refs/heads/} !!!* Please review the findings by clicking the button below."
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow"
                    },
                    "url": "${{ steps.repo_info.outputs.WORKFLOW_URL }}",
                    "style": "danger"
                  }
                ]
              }
            ]
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_WEBHOOK_URL }}
