name: Unearth Credentials
on:
  workflow_call:
jobs:
  unearth-credentials:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
      - name: exlclude git
        run: rm -rf .git
      - name: install trufflehog and jq
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
      - name: Run trufflehog
        id: trufflehog_scan
        run: |
          trufflehog filesystem --json ./ > trufflehog_raw_output.json
          jq -s '.' trufflehog_raw_output.json> trufflehog_output.json
          python ci/scanner.py --input trufflehog_output.json --output final_trufflehog_output.json
          if [ ! -s trufflehog_raw_output.json ]; then
              echo "trufflehog_findings=null" >> $GITHUB_OUTPUT
          else
              echo "trufflehog_findings=true" >> $GITHUB_OUTPUT
          fi
      - id: repo_info
        run: |
          REPO_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
          WORKFLOW_URL="${REPO_URL}/actions/runs/${GITHUB_RUN_ID}"
          echo "WORKFLOW_URL=$WORKFLOW_URL" >> $GITHUB_OUTPUT
      - name: slack-send
        if: steps.trufflehog_scan.outputs.trufflehog_findings == 'true'
        run: |
          payload=$(cat <<EOF
          {
            "text": "ðŸš¨ !!! Hard-coded Credentials found in ${{ github.repository }}. !!! Please review the findings by clicking the button below.",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": ":alert: *!!! Hard-coded Credentials found in ${{ github.repository }}, branch ${GITHUB_REF#refs/heads/} !!!* Please review the findings by clicking the button below."
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow"
                    },
                    "url": "${{ steps.repo_info.outputs.WORKFLOW_URL }}",
                    "style": "danger"
                  }
                ]
              }
            ]
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' --data "$payload" $SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_WEBHOOK_URL }}